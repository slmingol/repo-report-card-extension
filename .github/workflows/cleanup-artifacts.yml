name: Cleanup Old Artifacts

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup-artifacts:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const daysToKeep = 7;
            const currentDate = new Date();
            const cutoffDate = new Date(currentDate.getTime() - (daysToKeep * 24 * 60 * 60 * 1000));
            
            console.log(`Deleting artifacts older than ${daysToKeep} days (before ${cutoffDate.toISOString()})`);
            
            // Get all artifacts for the repository
            const artifacts = await github.paginate(
              github.rest.actions.listArtifactsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              }
            );
            
            let deletedCount = 0;
            let keptCount = 0;
            
            for (const artifact of artifacts) {
              const createdAt = new Date(artifact.created_at);
              
              if (createdAt < cutoffDate) {
                console.log(`Deleting artifact: ${artifact.name} (created: ${artifact.created_at})`);
                
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                
                deletedCount++;
              } else {
                keptCount++;
              }
            }
            
            console.log(`\nCleanup complete:`);
            console.log(`- Artifacts deleted: ${deletedCount}`);
            console.log(`- Artifacts kept: ${keptCount}`);
